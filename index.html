<!DOCTYPE html>
<html lang="nn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilgjengeleg?</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-fjord: #0099D8;
            --primary-sky: #33ADE3;
            --neutral-snow: #F8FAFB;
            --neutral-ice: #E5F4FA;
            --text-dark: #1E3A5F;
            --text-mid: #4A6B8A;
            --status-available: #4CAF8E;
            --status-busy: #D97757;
            --status-meeting: #5B8FBF;
            --status-away: #F5B942;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Work Sans', -apple-system, sans-serif;
            background: linear-gradient(135deg, var(--neutral-snow) 0%, var(--neutral-ice) 100%);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -20%;
            width: 80%;
            height: 120%;
            background: radial-gradient(circle, rgba(0, 153, 216, 0.1) 0%, transparent 70%);
            pointer-events: none;
            animation: floatBackground 20s ease-in-out infinite;
        }

        @keyframes floatBackground {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(-10%, 5%) scale(1.1); }
        }

        .container { max-width: 900px; width: 100%; position: relative; z-index: 1; }

        .card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 20px 60px rgba(44, 56, 50, 0.12), 0 8px 16px rgba(44, 56, 50, 0.08);
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'DM Serif Display', serif;
            font-size: 3.5rem;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            line-height: 1.1;
            font-weight: 400;
            letter-spacing: -0.02em;
            text-align: center;
        }

        .subtitle {
            font-size: 1.5rem;
            color: var(--text-mid);
            margin-bottom: 2.5rem;
            font-weight: 300;
            letter-spacing: 0.01em;
            text-align: center;
        }

        .status-display { text-align: center; margin: 2.5rem 0; }

        .status-indicator {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            margin: 0 auto 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.3);
            position: relative;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status-indicator::after {
            content: '';
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border-radius: 50%;
            background: inherit;
            opacity: 0.2;
            filter: blur(20px);
            z-index: -1;
        }

        .status-available { background: linear-gradient(135deg, var(--status-available) 0%, #6AC5A3 100%); }
        .status-busy { background: linear-gradient(135deg, var(--status-busy) 0%, #E68A6E 100%); }
        .status-meeting { background: linear-gradient(135deg, var(--status-meeting) 0%, #7AA8D1 100%); }
        .status-away { background: linear-gradient(135deg, var(--status-away) 0%, #F8C563 100%); }

        .status-text {
            font-family: 'DM Serif Display', serif;
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--text-dark);
        }

        .status-subtext {
            font-size: 1.375rem;
            color: var(--text-mid);
            font-weight: 300;
            line-height: 1.6;
            max-width: 600px;
            margin: 0 auto;
        }

        .upcoming-events {
            margin: 3rem 0 0 0;
            padding: 2rem;
            background: var(--neutral-ice);
            border-radius: 16px;
            border-left: 4px solid var(--primary-fjord);
        }

        .upcoming-events h3 {
            font-size: 1.375rem;
            color: var(--text-dark);
            margin-bottom: 1.5rem;
            font-weight: 500;
        }

        .event-list { display: flex; flex-direction: column; gap: 1rem; }

        .event-item {
            background: white;
            padding: 1.25rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 1.25rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
        }

        .event-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .event-time {
            font-weight: 600;
            color: var(--primary-fjord);
            font-size: 1.125rem;
            min-width: 100px;
            text-align: center;
            background: var(--neutral-ice);
            padding: 0.75rem;
            border-radius: 8px;
        }

        .event-details { flex: 1; }

        .event-title {
            font-size: 1.125rem;
            color: var(--text-dark);
            font-weight: 500;
            margin-bottom: 0.375rem;
        }

        .event-duration {
            font-size: 1rem;
            color: var(--text-mid);
        }

        .no-events {
            text-align: center;
            color: var(--text-mid);
            font-size: 1.125rem;
            padding: 2rem;
            font-style: italic;
        }

        .settings-link {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--primary-fjord);
            color: white;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0, 153, 216, 0.3);
            transition: all 0.3s;
            z-index: 1000;
        }

        .settings-link:hover {
            transform: translateY(-2px) rotate(90deg);
            box-shadow: 0 6px 16px rgba(0, 153, 216, 0.4);
        }

        .sync-indicator {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            font-size: 0.95rem;
            color: var(--text-mid);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            align-items: center;
            gap: 0.5rem;
        }

        .sync-indicator.active { display: flex; }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .sync-indicator.active::before {
            content: 'üîÑ';
            animation: spin 1s linear infinite;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2.5rem; }
            .subtitle { font-size: 1.125rem; }
            .status-indicator { width: 150px; height: 150px; font-size: 3.5rem; }
            .status-text { font-size: 2.25rem; }
            .status-subtext { font-size: 1.125rem; }
            .card { padding: 1.5rem; }
            .event-item { flex-direction: column; text-align: center; }
            .event-time { min-width: auto; width: 100%; }
            .settings-link { bottom: 1.5rem; right: 1.5rem; width: 56px; height: 56px; font-size: 1.5rem; }
            .upcoming-events { padding: 1.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>Tilgjengeleg?</h1>
            <p class="subtitle">Eg er</p>

            <div class="status-display">
                <div id="statusIndicator" class="status-indicator status-available">‚úì</div>
                <div id="statusText" class="status-text">Tilgjengeleg</div>
                <div id="statusSubtext" class="status-subtext">Bank gjerne p√•</div>
            </div>

            <div id="upcomingEvents" class="upcoming-events" style="display: none;">
                <h3>üìÖ Komande m√∏te (neste 12 timar)</h3>
                <div id="eventList" class="event-list"></div>
            </div>
        </div>
    </div>

    <div id="syncIndicator" class="sync-indicator">Synkroniserer...</div>
    <a href="innstillingar.html" class="settings-link" title="Innstillingar">‚öôÔ∏è</a>

    <script>
        const statusMessages = {
            available: 'Bank gjerne p√•',
            busy: 'Ikkje forstyrr, eg er djupt konsentrert',
            meeting: 'Pr√∏v igjen, etter at m√∏tet er avslutta',
            lunch: 'P√• lunsjpause',
            away: 'Ute fr√• kontoret. Send gjerne ein e-post'
        };

        let calendarSyncInterval = null;

        window.addEventListener('load', function() {
            const calendarUrl = localStorage.getItem('calendarUrl');
            if (calendarUrl) {
                const refreshInterval = parseInt(localStorage.getItem('refreshInterval')) || 60000;
                startCalendarSync(calendarUrl, refreshInterval);
            } else {
                loadAndDisplayStatus();
                checkAutoUpdate();
                setInterval(checkAutoUpdate, 60000);
            }
        });

        function loadAndDisplayStatus() {
            const saved = localStorage.getItem('tilgjenge-status');
            if (saved) {
                const data = JSON.parse(saved);
                displayStatus(data.status || 'available', data.customMessage || '');
            } else {
                displayStatus('available', '');
            }
        }

        function displayStatus(status, customMessage) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            const statusSubtext = document.getElementById('statusSubtext');

            let message = customMessage || statusMessages[status];

            const statusConfig = {
                available: { class: 'status-available', icon: '‚úì', text: 'Tilgjengeleg' },
                busy: { class: 'status-busy', icon: '‚óè', text: 'Oppteken' },
                meeting: { class: 'status-meeting', icon: '‚óã', text: 'I m√∏te' },
                lunch: { class: 'status-meeting', icon: 'üç¥', text: 'Lunsjpause' },
                away: { class: 'status-away', icon: '‚Üó', text: 'Ute' }
            };

            const config = statusConfig[status] || statusConfig.available;
            indicator.className = 'status-indicator ' + config.class;
            indicator.textContent = config.icon;
            statusText.textContent = config.text;
            statusSubtext.textContent = message;
        }

        function checkAutoUpdate() {
            const saved = localStorage.getItem('tilgjenge-status');
            if (!saved) return;

            const data = JSON.parse(saved);
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            if ((data.autoUntil && currentTime >= data.autoUntil) || 
                (data.autoReturn && currentTime >= data.autoReturn)) {
                data.status = 'available';
                data.autoUntil = '';
                data.autoReturn = '';
                localStorage.setItem('tilgjenge-status', JSON.stringify(data));
                loadAndDisplayStatus();
            }
        }

        function startCalendarSync(calendarUrl, refreshInterval) {
            fetchCalendarStatus(calendarUrl);
            if (calendarSyncInterval) clearInterval(calendarSyncInterval);
            calendarSyncInterval = setInterval(() => fetchCalendarStatus(calendarUrl), refreshInterval);
        }

        async function fetchCalendarStatus(calendarUrl) {
            showSyncIndicator();
            try {
                // Try direct fetch first
                let response;
                let icsData;
                
                try {
                    response = await fetch(calendarUrl);
                    icsData = await response.text();
                } catch (corsError) {
                    // If CORS error, try with proxy
                    console.log('Direct fetch failed, trying with CORS proxy...');
                    const proxyUrl = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(calendarUrl);
                    response = await fetch(proxyUrl);
                    icsData = await response.text();
                }

                const events = parseICS(icsData);
                const currentEvent = getCurrentEvent(events);
                const upcomingEvents = getUpcomingEvents(events, 12);

                if (currentEvent) {
                    displayStatus('meeting', currentEvent.summary || 'I m√∏te');
                } else {
                    const nextEvent = upcomingEvents[0];
                    if (nextEvent) {
                        displayStatus('available', `Neste m√∏te kl ${formatTime(new Date(nextEvent.start))}`);
                    } else {
                        displayStatus('available', '');
                    }
                }

                displayUpcomingEvents(upcomingEvents);
            } catch (error) {
                console.error('Calendar sync error:', error);
                // Fall back to manual status
                loadAndDisplayStatus();
                
                // Show error in console but don't alert user
                console.warn('Kunne ikkje hente kalenderdata. Brukar manuell status i staden.');
            }
            hideSyncIndicator();
        }

        function parseICS(icsData) {
            const events = [];
            const lines = icsData.split(/\r?\n/);
            let currentEvent = null;

            for (let line of lines) {
                line = line.trim();
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.start && currentEvent.end) events.push(currentEvent);
                    currentEvent = null;
                } else if (currentEvent) {
                    if (line.startsWith('DTSTART')) currentEvent.start = parseICSDate(line.split(':')[1]);
                    else if (line.startsWith('DTEND')) currentEvent.end = parseICSDate(line.split(':')[1]);
                    else if (line.startsWith('SUMMARY:')) currentEvent.summary = line.substring(8);
                }
            }
            return events;
        }

        function parseICSDate(dateStr) {
            dateStr = dateStr.replace(/[TZ]/g, '');
            return new Date(`${dateStr.substr(0,4)}-${dateStr.substr(4,2)}-${dateStr.substr(6,2)}T${dateStr.substr(8,2)}:${dateStr.substr(10,2)}:00`);
        }

        function getCurrentEvent(events) {
            const now = new Date();
            return events.find(e => now >= e.start && now <= e.end);
        }

        function getUpcomingEvents(events, hours) {
            const now = new Date();
            const maxTime = new Date(now.getTime() + hours * 60 * 60 * 1000);
            return events.filter(e => e.start > now && e.start <= maxTime).sort((a, b) => a.start - b.start).slice(0, 10);
        }

        function displayUpcomingEvents(events) {
            const container = document.getElementById('upcomingEvents');
            const eventList = document.getElementById('eventList');

            if (events.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            eventList.innerHTML = events.map(e => `
                <div class="event-item">
                    <div class="event-time">${formatTime(new Date(e.start))}</div>
                    <div class="event-details">
                        <div class="event-title">${escapeHtml(e.summary || 'M√∏te')}</div>
                        <div class="event-duration">${formatTime(new Date(e.end))} (${calculateDuration(e.start, e.end)})</div>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(date) {
            return date.toLocaleTimeString('nb-NO', { hour: '2-digit', minute: '2-digit' });
        }

        function calculateDuration(start, end) {
            const diffMins = Math.round((end - start) / 60000);
            if (diffMins < 60) return `${diffMins} min`;
            const hours = Math.floor(diffMins / 60);
            const mins = diffMins % 60;
            return mins > 0 ? `${hours}t ${mins}min` : `${hours}t`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSyncIndicator() {
            document.getElementById('syncIndicator').classList.add('active');
        }

        function hideSyncIndicator() {
            setTimeout(() => document.getElementById('syncIndicator').classList.remove('active'), 1000);
        }
    </script>
</body>
</html>
