<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tilgjengelig?</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=Work+Sans:wght@300;400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-fjord: #0099D8;
      --primary-sky: #33ADE3;
      --neutral-snow: #F8FAFB;
      --neutral-ice: #E5F4FA;
      --text-dark: #1E3A5F;
      --text-mid: #4A6B8A;
      --accent-glacier: #66BFEB;
      --status-available: #4CAF8E;
      --status-busy: #D97757;
      --status-meeting: #5B8FBF;
      --status-away: #F5B942;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Work Sans',-apple-system,sans-serif;background:linear-gradient(135deg,var(--neutral-snow) 0%,var(--neutral-ice) 100%);color:var(--text-dark);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem;position:relative;overflow:hidden}
    body::before{content:'';position:absolute;top:-50%;right:-20%;width:80%;height:120%;background:radial-gradient(circle,rgba(0,153,216,.1) 0%,transparent 70%);pointer-events:none;animation:floatBackground 20s ease-in-out infinite}
    body::after{content:'';position:absolute;bottom:-10%;left:-10%;width:60%;height:60%;background:radial-gradient(ellipse at center,rgba(51,173,227,.08) 0%,transparent 60%);pointer-events:none;animation:floatBackground 25s ease-in-out infinite reverse}
    @keyframes floatBackground{0%,100%{transform:translate(0,0) scale(1)}50%{transform:translate(-10%,5%) scale(1.1)}}

    .container{max-width:900px;width:100%;position:relative;z-index:1}
    .card{background:rgba(255,255,255,.9);backdrop-filter:blur(20px);border-radius:24px;padding:3rem;box-shadow:0 20px 60px rgba(44,56,50,.12),0 8px 16px rgba(44,56,50,.08);animation:slideUp .6s ease-out}
    @keyframes slideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}

    h1{font-family:'DM Serif Display',serif;font-size:3.2rem;color:var(--text-dark);margin-bottom:.5rem;line-height:1.1;font-weight:400;letter-spacing:-.02em;text-align:center}
    .subtitle{font-size:1.1rem;color:var(--text-mid);margin-bottom:2rem;font-weight:300;letter-spacing:.01em;text-align:center}

    .status-display{text-align:center;margin:2rem 0}
    .status-indicator{width:180px;height:180px;border-radius:50%;margin:0 auto 1.5rem;display:flex;align-items:center;justify-content:center;font-size:4rem;box-shadow:0 10px 30px rgba(0,0,0,.15),inset 0 1px 0 rgba(255,255,255,.3);position:relative;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .status-indicator::after{content:'';position:absolute;top:-10px;left:-10px;right:-10px;bottom:-10px;border-radius:50%;background:inherit;opacity:.2;filter:blur(20px);z-index:-1}

    .status-available{background:linear-gradient(135deg,var(--status-available) 0%,#6AC5A3 100%)}
    .status-busy{background:linear-gradient(135deg,var(--status-busy) 0%,#E68A6E 100%)}
    .status-meeting{background:linear-gradient(135deg,var(--status-meeting) 0%,#7AA8D1 100%)}
    .status-away{background:linear-gradient(135deg,var(--status-away) 0%,#F8C563 100%)}

    .status-text{font-family:'DM Serif Display',serif;font-size:2.4rem;margin-bottom:.35rem}
    .status-subtext{color:var(--text-mid);font-size:1.05rem;font-weight:300;margin-bottom:1rem}

    .controls{display:flex;gap:1rem;flex-wrap:wrap;justify-content:center;margin-top:1.25rem}
    .control-group{margin-top:1rem}
    label{display:block;margin-bottom:.4rem;color:var(--text-mid);font-size:.95rem}
    select,input,textarea{width:100%;padding:.8rem .85rem;border-radius:14px;border:1px solid rgba(30,58,95,.15);background:#fff;font:inherit}
    textarea{min-height:78px;resize:vertical}

    .btn{background:var(--primary-fjord);color:#fff;border:none;border-radius:14px;padding:.85rem 1.1rem;font-weight:500;cursor:pointer;box-shadow:0 10px 25px rgba(0,153,216,.25)}
    .btn-secondary{background:rgba(30,58,95,.08);color:var(--text-dark);box-shadow:none}

    .divider{height:1px;background:rgba(30,58,95,.08);margin:2rem 0}
    .help-text{color:var(--text-mid);font-size:.9rem;line-height:1.35;margin-top:.35rem}

    .upcoming{margin-top:1.5rem}
    .upcoming h2{font-size:1.1rem;font-weight:500;margin-bottom:.75rem}
    .upcoming-list{list-style:none;display:flex;flex-direction:column;gap:.5rem}
    .upcoming-item{padding:.75rem .9rem;border-radius:14px;background:rgba(255,255,255,.7);border:1px solid rgba(30,58,95,.08)}
    .upcoming-item .t{display:flex;justify-content:space-between;gap:1rem;align-items:baseline}
    .upcoming-item .s{font-weight:500}
    .upcoming-item .time{color:var(--text-mid);font-size:.9rem;white-space:nowrap}
    .upcoming-item .meta{color:var(--text-mid);font-size:.9rem;margin-top:.15rem}

    .hidden{display:none !important}

    @media (max-width:640px){
      h1{font-size:2.4rem}
      .status-indicator{width:140px;height:140px;font-size:3rem}
      .status-text{font-size:2rem}
      .card{padding:2rem}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Tilgjengelig?</h1>
      <p class="subtitle">Manuell status (med valgfri ICS-synk)</p>

      <div class="status-display">
        <div id="statusIndicator" class="status-indicator status-available">âœ“</div>
        <div id="statusText" class="status-text">Tilgjengelig</div>
        <div id="statusSubtext" class="status-subtext">Bank gjerne pÃ¥.</div>
      </div>

      <div class="controls">
        <a class="btn btn-secondary" href="settings.html" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">Innstillinger</a>
      </div>

      <div class="divider"></div>

      <div class="control-group">
        <label for="statusSelect">Status</label>
        <select id="statusSelect" onchange="updateStatus()">
          <option value="available">Tilgjengelig</option>
          <option value="busy">Opptatt</option>
          <option value="meeting">I mÃ¸te</option>
          <option value="away">Borte</option>
        </select>
      </div>

      <div class="control-group">
        <label for="customMessage">Melding</label>
        <textarea id="customMessage" placeholder="Skriv en kort meldingâ€¦" oninput="updateStatus()"></textarea>
        <p class="help-text">Meldingen vises under status (f.eks. Â«Tilgjengelig etter 14:00Â»).</p>
      </div>

      <div class="controls">
        <button class="btn btn-secondary" onclick="saveToLocalStorage()">ðŸ’¾ Lagre</button>
      </div>

      <div id="upcoming" class="upcoming hidden">
        <h2>Kommende hendelser (neste 12 timer)</h2>
        <ul id="upcomingList" class="upcoming-list"></ul>
      </div>
    </div>
  </div>

<script>
  let calendarSyncInterval = null;

  const statusMessages = {
    available: 'Bank gjerne pÃ¥.',
    busy: 'Ikke forstyrr, jeg er dypt konsentrert',
    meeting: 'PrÃ¸v igjen etter at mÃ¸tet er avsluttet',
    away: 'Ute av kontoret. Send gjerne en e-post'
  };

  window.addEventListener('load', function(){
    loadFromLocalStorage();
    // standard detaljer fra settings
    const cfgRaw = localStorage.getItem('tilgjenge-config');
    const cfg = cfgRaw ? JSON.parse(cfgRaw) : {};

    const calendarUrl = cfg.calendarUrl || localStorage.getItem('calendarUrl');
    if (calendarUrl){
      const refreshInterval = Number(cfg.refreshInterval || localStorage.getItem('refreshInterval') || 60000);
      startCalendarSync(calendarUrl, refreshInterval);
    }
  });

  function updateStatus(){
    const status = document.getElementById('statusSelect').value;
    const msg = document.getElementById('customMessage').value.trim();

    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');
    const statusSub = document.getElementById('statusSubtext');

    indicator.className = 'status-indicator ' + (
      status === 'available' ? 'status-available' :
      status === 'busy' ? 'status-busy' :
      status === 'meeting' ? 'status-meeting' : 'status-away'
    );

    indicator.textContent = status === 'available' ? 'âœ“' : (status === 'busy' ? 'â—' : 'â—‹');

    statusText.textContent = (
      status === 'available' ? 'Tilgjengelig' :
      status === 'busy' ? 'Opptatt' :
      status === 'meeting' ? 'I mÃ¸te' : 'Borte'
    );

    statusSub.textContent = msg || statusMessages[status];
  }

  function saveToLocalStorage(){
    const data = {
      status: document.getElementById('statusSelect').value,
      customMessage: document.getElementById('customMessage').value
    };
    localStorage.setItem('tilgjenge-status', JSON.stringify(data));
  }

  function loadFromLocalStorage(){
    const saved = localStorage.getItem('tilgjenge-status');
    if (!saved) return;
    const data = JSON.parse(saved);
    document.getElementById('statusSelect').value = data.status || 'available';
    document.getElementById('customMessage').value = data.customMessage || '';
    updateStatus();
  }

  // --- ICS sync + kommende 12t ---
  function unfoldIcsLines(text){
    return text.replace(/\r\n[ \t]/g,'');
  }

  function parseIcsDate(value){
    const v = value.trim();
    if (/^\d{8}T\d{6}Z$/.test(v)){
      const y=v.slice(0,4),m=v.slice(4,6),d=v.slice(6,8),hh=v.slice(9,11),mm=v.slice(11,13),ss=v.slice(13,15);
      return new Date(Date.UTC(Number(y),Number(m)-1,Number(d),Number(hh),Number(mm),Number(ss)));
    }
    if (/^\d{8}T\d{6}$/.test(v)){
      const y=v.slice(0,4),m=v.slice(4,6),d=v.slice(6,8),hh=v.slice(9,11),mm=v.slice(11,13),ss=v.slice(13,15);
      return new Date(`${y}-${m}-${d}T${hh}:${mm}:${ss}`);
    }
    if (/^\d{8}$/.test(v)){
      const y=v.slice(0,4),m=v.slice(4,6),d=v.slice(6,8);
      return new Date(`${y}-${m}-${d}T00:00:00`);
    }
    const dt = new Date(v);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function parseIcsEvents(icsText){
    const text = unfoldIcsLines(icsText);
    const lines = text.split(/\r?\n/);
    const events = [];
    let e = null;

    for (const rawLine of lines){
      const line = rawLine.trim();
      if (!line) continue;
      if (line === 'BEGIN:VEVENT'){ e = {}; continue; }
      if (line === 'END:VEVENT'){
        if (e && e.start && e.end) events.push(e);
        e = null; continue;
      }
      if (!e) continue;

      const idx = line.indexOf(':');
      if (idx === -1) continue;
      const left = line.slice(0, idx);
      const value = line.slice(idx+1);
      const key = left.split(';')[0].toUpperCase();

      if (key === 'DTSTART') e.start = parseIcsDate(value);
      if (key === 'DTEND') e.end = parseIcsDate(value);
      if (key === 'SUMMARY') e.summary = value;
      if (key === 'LOCATION') e.location = value;
      if (key === 'STATUS') e.status = value;
      if (key === 'TRANSP') e.transp = value;
    }

    return events
      .filter(ev => ev.start && ev.end && !isNaN(ev.start.getTime()) && !isNaN(ev.end.getTime()))
      .sort((a,b) => a.start - b.start);
  }

  function isBusyEvent(ev){
    if ((ev.status || '').toUpperCase() === 'CANCELLED') return false;
    if ((ev.transp || '').toUpperCase() === 'TRANSPARENT') return false;
    return true;
  }

  function formatTime(date){
    return date.toLocaleTimeString('nb-NO',{hour:'2-digit',minute:'2-digit'});
  }

  function buildUpcomingList(events, now){
    const box = document.getElementById('upcoming');
    const list = document.getElementById('upcomingList');
    list.innerHTML = '';
    box.classList.remove('hidden');

    const endWindow = new Date(now.getTime() + 12*60*60000);
    const upcoming = events
      .filter(ev => isBusyEvent(ev))
      .filter(ev => ev.start >= now && ev.start <= endWindow)
      .slice(0, 12);

    if (upcoming.length === 0){
      const li = document.createElement('li');
      li.className = 'upcoming-item';
      li.textContent = 'Ingen hendelser de neste 12 timene.';
      list.appendChild(li);
      return;
    }

    for (const ev of upcoming){
      const li = document.createElement('li');
      li.className = 'upcoming-item';
      const title = ev.summary || 'Hendelse';
      const time = `${formatTime(ev.start)}â€“${formatTime(ev.end)}`;
      const meta = ev.location || '';

      li.innerHTML = `
        <div class="t">
          <div class="s"></div>
          <div class="time"></div>
        </div>
        <div class="meta"></div>
      `;
      li.querySelector('.s').textContent = title;
      li.querySelector('.time').textContent = time;
      li.querySelector('.meta').textContent = meta;
      list.appendChild(li);
    }
  }

  async function fetchCalendarStatus(calendarUrl){
    const response = await fetch(calendarUrl, { cache: 'no-store' });
    const icsData = await response.text();
    const events = parseIcsEvents(icsData);

    const now = new Date();
    const currentEvent = events.find(ev => isBusyEvent(ev) && now >= ev.start && now <= ev.end);

    if (currentEvent){
      document.getElementById('statusSelect').value = 'meeting';
      document.getElementById('customMessage').value = currentEvent.summary || 'I mÃ¸te';
      updateStatus();
    } else {
      const nextEvent = events.find(ev => isBusyEvent(ev) && ev.start > now);
      if (nextEvent){
        document.getElementById('statusSelect').value = 'available';
        document.getElementById('customMessage').value = `Neste mÃ¸te kl ${formatTime(nextEvent.start)}`;
        updateStatus();
      }
    }

    buildUpcomingList(events, now);
  }

  function startCalendarSync(calendarUrl, refreshInterval){
    fetchCalendarStatus(calendarUrl).catch(()=>{});
    if (calendarSyncInterval) clearInterval(calendarSyncInterval);
    calendarSyncInterval = setInterval(() => fetchCalendarStatus(calendarUrl).catch(()=>{}), refreshInterval);
  }
</script>
</body>
</html>
